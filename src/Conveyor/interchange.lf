target Python

import FrostBase from "../../frost/src/lib/FrostBase.lf"

reactor Interchange extends FrostBase{
    state conveyor_name = {=self.name.split(".")[-1]=}
    state interchange_time = 7000
    state pallet_present = False
    //Physical links
    input from_upper_belt
    input from_lower_belt
    output to_upper_belt
    output to_lower_belt

    logical action delay

    reaction(from_upper_belt) -> delay{=
        value = from_upper_belt.value[0]

        if not isinstance(value, Pallet):
            raise Exception(f"Interchange {self.conveyor_name.split(".")[-1]} error: received non-pallet value from upper belt: {value}")
        
        self.logger.debug(f"Interchange {self.conveyor_name.split(".")[-1]} received from upper belt: {value}")

        if self.pallet_present:
            raise Exception(f"Interchange {self.conveyor_name.split(".")[-1]} error: trying to send a pallet when another is still in the interchange")

        self.pallet_present = True    
        delay.schedule(MSEC(self.interchange_time), [True, value])
    =}

    reaction(from_lower_belt) -> delay{=
        value = from_lower_belt.value[0]

        if not isinstance(value, Pallet):
            raise Exception(f"Interchange {self.conveyor_name.split(".")[-1]} error: received non-pallet value from lower belt: {value}")

        self.logger.debug(f"Interchange {self.conveyor_name.split(".")[-1]} received from lower belt: {value}")

        if self.pallet_present:
            raise Exception(f"Interchange {self.conveyor_name.split(".")[-1]} error: trying to send a pallet when another is still in the interchange")

        self.pallet_present = True
        delay.schedule(MSEC(self.interchange_time), [False, value])
    =}

    reaction(delay) -> to_upper_belt, to_lower_belt{=
        condition = delay.value[0]    
        value = delay.value[1]            

        if condition:
            self._set_output_port(value, to_lower_belt)
            self.logger.debug(f"Interchange {self.conveyor_name.split(".")[-1]} sent low: {value}")
        else:
            self._set_output_port(value, to_upper_belt)
            self.logger.debug(f"Interchange {self.conveyor_name.split(".")[-1]} sent up: {value}")

        self.pallet_present = False
    =}

}